//Push to Blink

#include "stm32f4xx.h"

int main(void) {
    // 1. Enable Clocks 
    // Ubah GPIOC (LED Bawaan) menjadi GPIOB (LED Eksternal)
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN; // Enable Clock PORT B
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN; // Enable Clock PORT A (Tombol)
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;  // Enable Clock Timer 2

    // 2. Configure PB0 as Output (LED Eksternal) 
    // Reset mode bits
    GPIOB->MODER &= ~(0x3UL << (0 * 2)); 
    // Set mode Output (01)
    GPIOB->MODER |=  (0x1UL << (0 * 2));

    // 3. Configure PA0 as Input (Tombol Bawaan) 
    GPIOA->MODER &= ~(0x3UL << (0 * 2)); // Input mode (00)
    // Gunakan Pull-Up (01) karena tombol bawaan aktif low (ke Ground)
    GPIOA->PUPDR &= ~(0x3UL << (0 * 2));
    GPIOA->PUPDR |=  (0x1UL << (0 * 2));

    // 4. Configure TIM2 for Delay (Sesuai Slide 37) 
    TIM2->PSC = 16000; // Prescaler (16MHz / 16000 = 1 KHz tick)
    TIM2->ARR = 100;   // Auto-reload (100ms speed blink)
    TIM2->CNT = 0;
    TIM2->CR1 |= TIM_CR1_CEN; // Start Timer

    while (1) {
        // Cek Tombol Bawaan (PA0) 
        // Karena Active Low (Pull-Up), tombol ditekan = Logika 0 (Low)
        if (!(GPIOA->IDR & (1 << 0))) {
            
            // Toggle LED Eksternal (PB0)
            GPIOB->ODR ^= (1 << 0);

            // Timer Pooling Logic (Delay)
            TIM2->CNT = 0; // Reset counter manual
            // Wait for update event (UIF)
            while (!(TIM2->SR & TIM_SR_UIF));
            TIM2->SR &= ~TIM_SR_UIF; // Clear UIF

        } else {
            // Jika tombol dilepas, matikan LED 
            // LED Eksternal (Active High): 0 = Mati
            GPIOB->ODR &= ~(1 << 0);
        }
    }
}